generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TeamRole {
  owner
  admin
  member
  viewer
}

enum MeetingStatus {
  received
  audio_extracted
  transcribed
  summarized
  tasks_extracted
  ready
  failed
}

enum SummaryTemplate {
  daily
  one_on_one
  sales
  executive
  custom
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  memberships TeamMember[]
  auditLogs   AuditLog[]
  refreshTokens RefreshToken[]
}

model Team {
  id           String   @id @default(uuid())
  name         String
  retentionDays Int     @default(365)
  createdAt    DateTime @default(now())
  members      TeamMember[]
  meetings     Meeting[]
  auditLogs    AuditLog[]
  integrations IntegrationConfig[]
}

model TeamMember {
  teamId String
  userId String
  role   TeamRole
  createdAt DateTime @default(now())
  team   Team @relation(fields: [teamId], references: [id])
  user   User @relation(fields: [userId], references: [id])

  @@id([teamId, userId])
}

model Meeting {
  id          String         @id @default(uuid())
  teamId      String
  title       String
  startedAt   DateTime?
  endedAt     DateTime?
  status      MeetingStatus @default(received)
  language    String
  template    SummaryTemplate
  tags        String[]       @default([])
  participants String[]      @default([])
  consentRecordedAt DateTime?
  consentTextVersion String?
  createdAt   DateTime @default(now())
  deletedAt   DateTime?
  team        Team @relation(fields: [teamId], references: [id])
  mediaAssets MediaAsset[]
  transcript  Transcript?
  summaries   SummaryVersion[]
  tasks       Task[]
  decisions   Decision[]
}

model MediaAsset {
  id          String   @id @default(uuid())
  meetingId   String
  storageKey  String
  mime        String
  durationMs  Int?
  sizeBytes   Int
  createdAt   DateTime @default(now())
  meeting     Meeting @relation(fields: [meetingId], references: [id])
}

model Transcript {
  id         String   @id @default(uuid())
  meetingId  String   @unique
  fullText   String
  segments   Json
  language   String
  createdAt  DateTime @default(now())
  meeting    Meeting @relation(fields: [meetingId], references: [id])
}

model SummaryVersion {
  id        String   @id @default(uuid())
  meetingId String
  version   Int
  template  SummaryTemplate
  model     String
  summary   Json
  createdAt DateTime @default(now())
  meeting   Meeting @relation(fields: [meetingId], references: [id])
}

model Task {
  id        String   @id @default(uuid())
  meetingId String
  text      String
  owner     String?
  dueDate   DateTime?
  status    String @default("open")
  meeting   Meeting @relation(fields: [meetingId], references: [id])
}

model Decision {
  id        String   @id @default(uuid())
  meetingId String
  text      String
  owner     String?
  meeting   Meeting @relation(fields: [meetingId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  teamId    String
  userId    String
  action    String
  metadata  Json
  createdAt DateTime @default(now())
  team      Team @relation(fields: [teamId], references: [id])
  user      User @relation(fields: [userId], references: [id])
}

model IntegrationConfig {
  id        String   @id @default(uuid())
  teamId    String
  type      String
  settings  Json
  createdAt DateTime @default(now())
  team      Team @relation(fields: [teamId], references: [id])

  @@unique([teamId, type])
}

model MagicLink {
  id        String   @id @default(uuid())
  email     String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User @relation(fields: [userId], references: [id])
}
